<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>TB Drug Dose Calculator</title>

<style>
body{
    font-family: Arial, sans-serif;
    background:#f4f6f9;
    padding:30px;
}
.container{
    max-width:900px;
    margin:auto;
    background:white;
    padding:25px;
    border-radius:10px;
    box-shadow:0 4px 12px rgba(0,0,0,0.1);
}
h2,h3{
    text-align:center;
}
label{font-weight:bold;}
input{
    width:100%;
    padding:8px;
    margin:10px 0 20px;
    font-size:16px;
}
button{
    width:100%;
    padding:12px;
    background:#1976d2;
    color:white;
    border:none;
    border-radius:6px;
    font-size:16px;
    cursor:pointer;
}
.result{
    margin-top:25px;
    padding:15px;
    background:#eef3f8;
    border-radius:8px;
}
.drug{
    margin-bottom:18px;
    padding-bottom:10px;
    border-bottom:1px dashed #bbb;
}
.alert{color:red;font-weight:bold;}
.note{font-size:13px;color:#555;margin-top:15px;}
.section{margin-top:35px;}
</style>
</head>

<body>
<div class="container">

<h2>คำนวณขนาดยาวัณโรค</h2>

<label>อายุ (ปี)</label>
<input type="number" id="age" min="1">

<label>น้ำหนัก (kg)</label>
<input type="number" id="weight" min="1">

<button onclick="calculateAll()">คำนวณ</button>

<div id="result" class="result" style="display:none;"></div>

</div>

<script>
// ===== BASIC CALC =====
function calcRange(w,minMgKg,maxMgKg,maxDose){
    let lo=w*minMgKg;
    let hi=w*maxMgKg;
    return {
        min:Math.round(lo),
        max:Math.round(Math.min(hi,maxDose)),
        hiRaw:hi,
        exceed:hi>maxDose
    };
}

function bestTablet(minDose,maxDose,strength,maxDoseAbs){
    let best=null;
    let mid=(minDose+maxDose)/2;
    for(let t=0.5;t<=10;t+=0.5){
        let d=t*strength;
        if(d<minDose||d>maxDose||d>maxDoseAbs)continue;
        let diff=Math.abs(d-mid);
        if(!best||diff<best.diff){
            best={t,d,diff};
        }
    }
    return best;
}

// ===== FDC CALC =====
function calculateFDC(weight, components){
    let best=null;
    let bestScore=Infinity;

    for(let t=0.5;t<=8;t+=0.5){
        let ok=true;
        let score=0;

        for(let c of components){
            let dose=t*c.strength;
            let min=weight*c.min;
            let max=Math.min(weight*c.max,c.maxDose);

            if(dose<min||dose>max){
                ok=false;
                break;
            }
            score+=Math.abs(dose-(min+max)/2);
        }

        if(ok && score<bestScore){
            bestScore=score;
            best={tablets:t};
        }
    }
    return best;
}

// ===== MAIN =====
function calculateAll(){
    let w=+document.getElementById("weight").value;
    let age=+document.getElementById("age").value;
    if(!w||!age){alert("กรอกอายุและน้ำหนัก");return;}

    let H=calcRange(w,4,6,300);
    let R=calcRange(w,8,12,600);
    let Z=calcRange(w,20,30,2000);
    let E=calcRange(w,15,20,1200);

    let html="";

    function showDrug(title,range,options){
        html+=`<div class="drug"><b>${title}</b><br>
        ${range.min} – ${range.max} mg/day<br>`;
        options.forEach(o=>{
            let b=bestTablet(range.min,range.max,o.str,o.max);
            if(b){
                html+=`• ขนาดยาที่แนะนำ: ${b.t} เม็ด (${o.str} mg/tab) = ${b.d} mg<br>`;
            }
        });
        if(range.exceed){
            html+=`<span class="alert">⚠ max dose</span>`;
        }
        html+=`</div>`;
    }

    // ===== IRZE =====
    showDrug("Isoniazid (H) 4–6 mg/kg/day",H,[{str:100,max:300}]);
    showDrug("Rifampicin (R) 8–12 mg/kg/day",R,[{str:300,max:600},{str:450,max:600}]);
    showDrug("Pyrazinamide (Z) 20–30 mg/kg/day",Z,[{str:500,max:2000}]);
    showDrug("Ethambutol (E) 15–20 mg/kg/day",E,[{str:500,max:1200},{str:400,max:1200}]);

    // ===== 2FDC =====
    let fdc2=calculateFDC(w,[
        {strength:75,min:4,max:6,maxDose:300},
        {strength:150,min:8,max:12,maxDose:600}
    ]);
    html+=`<div class="drug"><b>2FDC (H75 + R150)</b><br>`;
    if(fdc2){
        html+=`ขนาดยาที่แนะนำ: ${fdc2.tablets} เม็ด/วัน`;
    }else{
        html+=`<span class="alert">ไม่สามารถคำนวณจำนวนเม็ดที่ลงตัวได้ โปรดใช้ดุลยพินิจ</span>`;
    }
    html+=`</div>`;

    // ===== 4FDC =====
    let fdc4=calculateFDC(w,[
        {strength:75,min:4,max:6,maxDose:300},
        {strength:150,min:8,max:12,maxDose:600},
        {strength:400,min:20,max:30,maxDose:2000},
        {strength:275,min:15,max:20,maxDose:1200}
    ]);
    html+=`<div class="drug"><b>4FDC (H75 + R150 + Z400 + E275)</b><br>`;
    if(fdc4){
        html+=`ขนาดยาที่แนะนำ: ${fdc4.tablets} เม็ด/วัน`;
    }else{
        html+=`<span class="alert">ไม่สามารถคำนวณจำนวนเม็ดที่ลงตัวได้ โปรดใช้ดุลยพินิจ</span>`;
    }
    html+=`</div>`;

    // ===== LTBI 3HP =====
    html+=`<div class="section"><h3>วัณโรคแฝง (3HP)</h3>
    <b>1 เม็ด = INH 300 mg + Rifapentine 300 mg</b><br>`;
    let note=false;

    if(age<=14){
        if(w<=15) html+=`ขนาดยา: INH 300 mg + Rifapentine 300 mg`;
        else if(w<=23) html+=`ขนาดยา: INH 500 mg + Rifapentine 450 mg`;
        else if(w<=30) html+=`ขนาดยา: INH 600 mg + Rifapentine 600 mg`;
        else html+=`ขนาดยา: INH 700 mg + Rifapentine 750 mg`;
    }else{
        let inh=Math.min(Math.ceil(w*15/100)*100,900);
        let rfp=w<=50?750:900;
        let tabs=Math.round(Math.max(inh,rfp)/300);

        if(tabs*300>inh||tabs*300>rfp) note=true;

        html+=`ขนาดยาที่คำนวณได้:<br>
        • INH ${inh} mg<br>
        • Rifapentine ${rfp} mg<br>
        ขนาดยาที่แนะนำ: ${tabs} เม็ด/สัปดาห์`;
    }
    if(note){
        html+=`<br><span class="alert">โปรดใช้ดุลยพินิจในการตัดสินใจ</span>`;
    }
    html+=`</div>`;

    html+=`<div class="note">
    ⚠ การคำนวณอาจผิดพลาดได้ กรุณาตรวจสอบข้อมูลก่อนนำไปใช้
    </div>`;

    document.getElementById("result").style.display="block";
    document.getElementById("result").innerHTML=html;
}
</script>
</body>
</html>

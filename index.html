<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>TB Dose Calculator</title>
<style>
body { font-family: sans-serif; margin: 20px; }
input, button { padding: 6px; margin: 5px; }
.section { border: 1px solid #ccc; padding: 10px; margin-top: 15px; }
h3 { margin-top: 0; }
.small { font-size: 0.9em; color: #555; }
.warn { margin-top: 20px; color: darkred; font-weight: bold; }
</style>
</head>

<body>

<h2>โปรแกรมคำนวณขนาดยาวัณโรค</h2>

อายุ (ปี):
<input type="number" id="age"><br>
น้ำหนัก (กก.):
<input type="number" id="weight"><br>

<button onclick="calculate()">คำนวณ</button>

<div id="result"></div>

<script>
function calculate() {
  const w = parseFloat(document.getElementById("weight").value);
  if (!w || w <= 0) {
    alert("กรุณากรอกน้ำหนักให้ถูกต้อง");
    return;
  }

  let html = "";

  /* =========================
     1) แยกเม็ดยาเดี่ยว
  ==========================*/
  html += `<div class="section"><h3>1️⃣ แยกเม็ดยาเดี่ยว</h3>`;

  html += calcDrug("Isoniazid (I)", w, 5, [100]);
  html += calcDrug("Rifampicin (R)", w, 10, [300, 450]);
  html += calcDrug("Pyrazinamide (Z)", w, 25, [500]);
  html += calcDrug("Ethambutol (E)", w, 15, [400, 500]);

  html += `</div>`;

  /* =========================
     2) 2FDC
  ==========================*/
  html += `<div class="section"><h3>2️⃣ 2FDC (I/R 300/300 mg)</h3>`;
  html += calcFDC(w, 300);
  html += `</div>`;

  /* =========================
     3) 4FDC
  ==========================*/
  html += `<div class="section"><h3>3️⃣ 4FDC (75/150/400/275 mg)</h3>`;
  html += calcFDC(w, 150);
  html += `</div>`;

  /* =========================
     4) 3HP
  ==========================*/
  html += `<div class="section"><h3>4️⃣ 3HP (Isoniazid/Rifapentine 300/300 mg)</h3>`;
  let dose3hp = w * 15;
  let tabs3hp = preferWhole(dose3hp / 300);
  html += `แนะนำ: <b>${tabs3hp}</b> เม็ด/สัปดาห์<br>`;
  html += `ปริมาณยาที่ได้ ≈ ${(tabs3hp * 300).toFixed(0)} mg`;
  html += `</div>`;

  html += `<div class="warn">
  ⚠️ โปรแกรมอาจคำนวณผิดพลาดได้<br>
  โปรดตรวจสอบก่อนนำข้อมูลไปใช้<br>
  ไม่สามารถใช้ทดแทนดุลยพินิจแพทย์ได้
  </div>`;

  document.getElementById("result").innerHTML = html;
}

/* =========================
   CORE FUNCTIONS
=========================*/
function preferWhole(x) {
  let full = Math.round(x);
  if (Math.abs(full - x) / x <= 0.1) return full;
  return Math.round(x * 2) / 2;
}

function calcDrug(name, w, mgkg, strengths) {
  let dose = w * mgkg;
  let out = `<b>${name}</b><br>`;

  strengths.forEach(strength => {
    let rawTabs = dose / strength;
    let tabs = preferWhole(rawTabs);

    let minW = ((tabs - 0.5) * strength) / mgkg;
    let maxW = ((tabs + 0.5) * strength) / mgkg;

    out += `
    • เม็ดละ ${strength} mg → <b>${tabs}</b> เม็ด 
      (${(tabs * strength).toFixed(0)} mg)
      <span class="small">
      [ช่วงน้ำหนักประมาณ ${minW.toFixed(1)} – ${maxW.toFixed(1)} กก.]
      </span><br>`;
  });

  return out + "<br>";
}

function calcFDC(w, mgPerTab) {
  let dose = w * 10;
  let tabs = preferWhole(dose / mgPerTab);
  return `แนะนำ: <b>${tabs}</b> เม็ด (${(tabs * mgPerTab).toFixed(0)} mg)<br>`;
}
</script>

</body>
</html>

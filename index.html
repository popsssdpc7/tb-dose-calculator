<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>TB Dose Calculator</title>
<style>
body { font-family: Arial, sans-serif; background:#f4f6f9; padding:20px; }
.container { max-width:850px; margin:auto; background:#fff; padding:20px; border-radius:8px; }
.section { margin-top:25px; padding-top:15px; border-top:2px solid #ccc; }
.drug { margin-bottom:15px; }
.warn { margin-top:25px; color:darkred; font-weight:bold; }
.note { font-size:0.9em; color:#555; }
</style>
</head>

<body>
<div class="container">
<h2>คำนวณขนาดยาวัณโรค</h2>

อายุ (ปี):
<input type="number" id="age"><br><br>
น้ำหนัก (kg):
<input type="number" id="weight"><br><br>

<button onclick="calculate()">คำนวณ</button>

<div id="result"></div>
</div>

<script>
/* ======================
   Helper
======================*/
function tabText(minTab, maxTab, strength) {
  if (minTab === maxTab) {
    return `• ${minTab} เม็ด (${strength} mg/เม็ด)<br>`;
  }
  return `• ${minTab} – ${maxTab} เม็ด (${strength} mg/เม็ด)<br>`;
}

/* ======================
   แยกเม็ดยา
======================*/
function drugBlock(name, w, minMgKg, maxMgKg, strengths) {
  const minDose = w * minMgKg;
  const maxDose = w * maxMgKg;

  let html = `<div class="drug">
  <b>${name}</b> ${minMgKg}–${maxMgKg} mg/kg/day<br>
  <b>ขนาดยาที่คำนวณได้:</b> ${minDose.toFixed(0)} – ${maxDose.toFixed(0)} mg/day<br>
  <b>คำแนะนำ:</b><br>`;

  strengths.forEach(s => {
    const minTab = Math.ceil(minDose / s);
    const maxTab = Math.floor(maxDose / s);

    if (minTab <= maxTab) {
      html += tabText(minTab, maxTab, s);
    } else {
      html += `• ไม่สามารถจัดเป็นเม็ดเต็มได้ (${s} mg/เม็ด) → ใช้ดุลยพินิจ<br>`;
    }
  });

  html += `</div>`;
  return html;
}

/* ======================
   2FDC / 4FDC
======================*/
function fdcBlock(title, w, minMgKg, maxMgKg, refMgPerTab) {
  const minDose = w * minMgKg;
  const maxDose = w * maxMgKg;

  const minTab = Math.ceil(minDose / refMgPerTab);
  const maxTab = Math.floor(maxDose / refMgPerTab);

  let html = `<div class="drug">
  <b>${title}</b><br>
  ขนาดยาที่คำนวณได้: ${minDose.toFixed(0)} – ${maxDose.toFixed(0)} mg/day<br>`;

  if (minTab <= maxTab) {
    html += `<b>คำแนะนำ:</b><br>`;
    html += tabText(minTab, maxTab, "ต่อสูตร FDC");
  } else {
    html += `<b>คำแนะนำ:</b> ไม่สามารถคำนวณจำนวนเม็ดเต็มที่อยู่ในช่วงขนาดยาได้<br>`;
  }

  return html + `</div>`;
}

/* ======================
   3HP (LTBI)
======================*/
function calc3HP(age, w) {
  let html = `<div class="drug">
  <b>3HP (วัณโรคแฝง)</b><br>
  1 เม็ด = Isoniazid 300 mg + Rifapentine 300 mg<br>`;

  let inh, rif;

  if (age <= 14) {
    if (w <= 15) { inh = 300; rif = 300; }
    else if (w <= 23) { inh = 500; rif = 450; }
    else if (w <= 30) { inh = 600; rif = 600; }
    else { inh = 700; rif = 750; }
  } else {
    inh = Math.min(Math.ceil((w * 15) / 100) * 100, 900);
    rif = (w <= 50) ? 750 : 900;
  }

  html += `
  <b>ขนาดยาที่คำนวณได้:</b><br>
  • INH ${inh} mg<br>
  • Rifapentine ${rif} mg<br><br>`;

  const minTab = Math.ceil(Math.max(inh, rif) / 300);
  const actual = minTab * 300;

  html += `<b>คำแนะนำ:</b><br>`;
  html += `• ${minTab} เม็ด/สัปดาห์ (INH ${actual} mg + Rifapentine ${actual} mg)<br>`;

  if (actual > inh || actual > rif) {
    html += `<span class="note">⚠ ปริมาณยาสูงกว่าที่คำนวณได้ โปรดใช้ดุลยพินิจ</span>`;
  }

  return html + `</div>`;
}

/* ======================
   Main
======================*/
function calculate() {
  const w = parseFloat(document.getElementById("weight").value);
  const age = parseFloat(document.getElementById("age").value);

  if (!w || w <= 0) {
    alert("กรุณากรอกน้ำหนัก");
    return;
  }

  let html = "";

  html += `<div class="section"><h3>1️⃣ แยกเม็ดยา I / R / Z / E</h3>`;
  html += drugBlock("Isoniazid (I)", w, 4, 6, [100]);
  html += drugBlock("Rifampicin (R)", w, 8, 12, [300, 450]);
  html += drugBlock("Pyrazinamide (Z)", w, 20, 30, [500]);
  html += drugBlock("Ethambutol (E)", w, 15, 20, [400, 500]);
  html += `</div>`;

  html += `<div class="section"><h3>2️⃣ 2FDC</h3>`;
  html += fdcBlock("2FDC (H75 + R150)", w, 8, 12, 150);
  html += `</div>`;

  html += `<div class="section"><h3>3️⃣ 4FDC</h3>`;
  html += fdcBlock("4FDC (H75 + R150 + Z400 + E275)", w, 20, 30, 400);
  html += `</div>`;

  html += `<div class="section"><h3>4️⃣ วัณโรคแฝง (3HP)</h3>`;
  html += calc3HP(age, w);
  html += `</div>`;

  html += `<div class="warn">
  ⚠ โปรแกรมอาจคำนวณผิดพลาดได้ กรุณาตรวจสอบก่อนนำไปใช้  
  ไม่ทดแทนดุลยพินิจแพทย์
  </div>`;

  document.getElementById("result").innerHTML = html;
}
</script>
</body>
</html>
